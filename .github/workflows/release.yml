name: Release

on:
  issue_comment:
    types: [created]

jobs:
  release:
    if: |
      !github.event.issue.pull_request && 
      startsWith(github.event.issue.title, 'ğŸ¤ [Release]') &&
      startsWith(github.event.comment.body, '/start') &&
      contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)
    
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY_SECRET }}
          fetch-depth: 0

      - name: Parse Version
        id: parse_version
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # 1. ë²„ì „ íŒŒì‹±
          RAW_VERSION=$(echo "${{ github.event.comment.body }}" | awk '{print $2}')
          
          # 2. ë²„ì „ ëˆ„ë½ ì²´í¬
          if [ -z "$RAW_VERSION" ]; then
            echo "VERSION_MISSING=true" >> $GITHUB_ENV
            exit 1
          fi
          
          # 3. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          STRIPPED_VERSION=$(echo $RAW_VERSION | sed 's/^v//')
          echo "RAW_VERSION=$RAW_VERSION" >> $GITHUB_ENV
          echo "STRIPPED_VERSION=$STRIPPED_VERSION" >> $GITHUB_ENV

          # 4. ì‹œì‘ ì½”ë©˜íŠ¸ ë‚¨ê¸°ê¸° (ë²„ì „ì´ ìˆì„ ë•Œë§Œ ì‹¤í–‰ë¨)
          gh issue comment ${{ github.event.issue.number }} --body "ğŸš€ **ë¦´ë¦¬ì¦ˆ ì‘ì—…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ($RAW_VERSION)**"

      - name: Git Config Setup
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Process Release and Direct Merge
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RAW_VER=${{ env.RAW_VERSION }}
          STRIP_VER=${{ env.STRIPPED_VERSION }}
          RELEASE_BRANCH="release/$RAW_VER"
          XCODE_PROJ_PATH="QueenCam/QueenCam.xcodeproj/project.pbxproj"
          TODAY=$(date +'%Y-%m-%d')
          REPO_URL="https://github.com/${{ github.repository }}"

          # 1. ì´ì „ ë²„ì „ ì¶”ì¶œ
          LAST_VERSION_STRIP=$(grep -oE '^## \[[0-9]+\.[0-9]+\.[0-9]+\]' CHANGELOG.md | head -n 1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
          LAST_VERSION_TAG="v$LAST_VERSION_STRIP"

          git checkout develop
          git checkout -b $RELEASE_BRANCH

          # 2. Xcode Version & Build ì—…ë°ì´íŠ¸
          sed -i "s/MARKETING_VERSION = .*/MARKETING_VERSION = $STRIP_VER;/g" $XCODE_PROJ_PATH
          OLD_BUILD_NUMBER=$(grep -m 1 "CURRENT_PROJECT_VERSION =" $XCODE_PROJ_PATH | sed -E 's/.*=[[:space:]]*([0-9]+);/\1/')
          NEW_BUILD_NUMBER=$((OLD_BUILD_NUMBER + 1))
          sed -i "s/CURRENT_PROJECT_VERSION = .*/CURRENT_PROJECT_VERSION = $NEW_BUILD_NUMBER;/g" $XCODE_PROJ_PATH
          
          git add .
          git commit -m "[Chore] release: $RAW_VER ë¹Œë“œ ë„˜ë²„ ì¦ê°€ ($NEW_BUILD_NUMBER)"

          # 3. CHANGELOG ì—…ë°ì´íŠ¸ ì‹œì‘
          
          # 3-1. ê¸°ì¡´ [Unreleased] í—¤ë”ë¥¼ í˜„ì¬ ë²„ì „ìœ¼ë¡œ êµì²´
          sed -i "s/.*## \[Unreleased\]/## [$STRIP_VER] - $TODAY/" CHANGELOG.md
          
          # 3-2. ìƒˆë¡œìš´ [Unreleased] í…œí”Œë¦¿ ì‚½ì…
          printf "\n## [Unreleased]\n\n### Added\n\n### Changed\n\n### Deprecated\n\n### Removed\n\n### Fixed\n\n### Security\n" > unreleased_tmp.txt
          
          # 'r' ëª…ë ¹ì–´ë¥¼ í†µí•´ ì§€ì •í•œ ìœ„ì¹˜ 'ë’¤'ì— íŒŒì¼ ë‚´ìš©ì„ ì½ì–´ì˜¨ë‹¤
          sed -i "/ê¸°ì¤€ìœ¼ë¡œ ìˆ˜í–‰í•œë‹¤\./r unreleased_tmp.txt" CHANGELOG.md
          rm unreleased_tmp.txt
          
          # 3-3. í•˜ë‹¨ ë§í¬ ì„¹ì…˜ ì—…ë°ì´íŠ¸
          NEW_DIFF_LINK="[$STRIP_VER]: $REPO_URL/compare/$LAST_VERSION_TAG...$RAW_VER"
          NEW_UNRELEASED_LINK="[Unreleased]: $REPO_URL/compare/$RAW_VER...HEAD"
          
          # ê¸°ì¡´ [Unreleased] ë§í¬ ì‚­ì œ (ì¤‘ë³µ ë°©ì§€)
          sed -i "/^\[Unreleased\]:/d" CHANGELOG.md
          
          # ë§í¬ ì¶”ê°€
          sed -i "0,/^\[.*\]:/{s|^\[.*\]:|$NEW_DIFF_LINK\n&|}" CHANGELOG.md
          sed -i "0,/^\[.*\]:/{s|^\[.*\]:|$NEW_UNRELEASED_LINK\n&|}" CHANGELOG.md

          git add CHANGELOG.md
          git commit -m "[Docs] release: $RAW_VER CHANGELOG.md"

          # 4. ë¸Œëœì¹˜ ë³‘í•© ë° í‘¸ì‹œ
          git push origin $RELEASE_BRANCH
          git checkout main
          git merge --no-ff $RELEASE_BRANCH -m "Merge release branch $RELEASE_BRANCH into main"
          git tag -a "$RAW_VER" -m "Release $RAW_VER"
          git checkout develop
          git merge --no-ff $RELEASE_BRANCH -m "Merge release branch $RELEASE_BRANCH back to develop"

          git push origin main develop --tags
          git branch -d $RELEASE_BRANCH

      - name: Post Failure Comment
        if: failure()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ env.VERSION_MISSING }}" == "true" ]; then
            gh issue comment ${{ github.event.issue.number }} --body "âŒ **ë²„ì „ì„ ì…ë ¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.** \`/start v1.2.3\` ê³¼ ê°™ì€ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”."
          else
            gh issue comment ${{ github.event.issue.number }} --body "âŒ **ë¦´ë¦¬ì¦ˆ ì‘ì—… ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (${{ env.RAW_VERSION }})**
            
            Actions íƒ­ì—ì„œ ìƒì„¸ ë¡œê·¸ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”."
          fi

      - name: Post Success Comment
        if: success()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "âœ… **ë¦´ë¦¬ì¦ˆ ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! (${{ env.RAW_VERSION }})**
          
          - **App Version:** ${{ env.STRIPPED_VERSION }}"
